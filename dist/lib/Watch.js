"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const events_1 = require("events");
const globby_1 = require("globby");
const callsite_1 = __importDefault(require("callsite"));
const os_1 = require("os");
const Colors_1 = require("./Colors");
if (!Array.prototype.unique) {
    Array.prototype.unique = function () {
        return this.filter((value, index) => {
            return this.indexOf(value) === index;
        });
    };
}
class Watcher extends events_1.EventEmitter {
    /**
     * File Watching using NodeJS fs.watch
     * @param globPattern The glob or array of globs to match against
     * @param watchOptions Options object
     */
    constructor(globPattern, watchOptions = {}) {
        super();
        this.options = { lockDuration: 1000, absolute: true, encoding: "utf-8", persistent: true, recursive: true, verbose: false };
        this.watchers = [];
        this.locked = false;
        this.locks = [];
        this.options = { ...this.options, ...watchOptions };
        // Callsite Gets the directory of the file this constructor was called from so we can glob from there instead of here
        this.options.cwd = (typeof this.options.cwd === "undefined") ? path.dirname(callsite_1.default()[1].getFileName()) : this.options.cwd;
        this.files = this.globFiles(globPattern).map((g) => path.normalize(g));
        this.directories = this.files.map((f) => path.dirname(f)).unique();
    }
    log(...logargs) {
        if (this.options.verbose) {
            // tslint:disable-next-line:no-console
            console.log(`${os_1.EOL}${Colors_1.Colors(`ReloadWatcher::${callsite_1.default()[1].getFunctionName()}`, "yellow")}`, ...logargs, os_1.EOL);
        }
    }
    globFiles(globPattern) {
        return globby_1.sync(globPattern, this.options);
    }
    isDirectory(source) {
        return fs.lstatSync(source).isDirectory();
    }
    isFile(source) {
        return !fs.lstatSync(source).isDirectory();
    }
    getDirectories(source) {
        return fs.readdirSync(source).map((name) => path.normalize(path.join(source, name))).filter(this.isDirectory);
    }
    getFiles(dir) {
        return fs.readdirSync(dir).map((name) => path.normalize(path.join(dir, name))).filter(this.isFile);
    }
    onWatchEventFile(e, f) {
        if (this.locked || e !== "change") {
            return;
        }
        this.lock();
        this.log("Node.js FSEvent:", e, "Node FSEvent File:", f);
        this.emit("all", f);
        this.emit("change", f);
    }
    /**
     * fs.watch event handler for directories
     * We watch directories for add, rename delete events so we can add and remove new listeners as necessary
     *
     * @param e {string} event type
     * @param f {string} file
     * @param dir {string} the directory
     */
    onWatchEventDir(e, f, dir) {
        if (this.locked || e !== "rename") {
            return;
        }
        this.lock();
        this.log("Node.js FSEvent:", e, "Node FSEvent File:", f, "Directory:", dir);
        const abs = path.join(dir, path.basename(f));
        if (!fs.existsSync(abs)) {
            const renamedFile = this.getRenamed(dir);
            if (typeof renamedFile !== "undefined") {
                this.log(`Old File: ${abs}`);
                this.log(`Renamed File: ${renamedFile}`);
                this.emit("all", abs, renamedFile);
                this.emit("rename", abs, renamedFile);
                this.removeWatcher(abs);
            }
            else {
                this.emit("all", abs);
                this.emit("delete", abs);
            }
            return;
        }
        if (!this.files.includes(abs)) {
            // Create
            this.watchers.push(this.createFileWatcher(abs));
            this.emit("all", abs);
            this.emit("add", abs);
        }
    }
    removeWatcher(file) {
        const watcherStruct = this.getWatcher(file);
        if (typeof watcherStruct !== "undefined") {
            watcherStruct.watcher.close();
            this.watchers.splice(this.watchers.indexOf(watcherStruct), 1);
        }
    }
    getRenamed(dir) {
        const FN_NAME = "isRename";
        const files = this.getFiles(dir);
        this.log("Disk Files:", files);
        this.log("Watched Files", this.files);
        for (const f of files) {
            if (!this.files.includes(f)) {
                return f;
            }
        }
        return undefined;
    }
    createFileWatcher(file) {
        return {
            target: file,
            watcher: fs.watch(file, this.options, (e, _) => { this.onWatchEventFile(e, file); })
        };
    }
    createDirWatcher(dir) {
        return {
            target: dir,
            watcher: fs.watch(dir, this.options, (e, f) => { this.onWatchEventDir(e, f, dir); })
        };
    }
    getWatcher(filename) {
        return this.watchers.find((w) => path.normalize(w.target) === path.normalize(filename));
    }
    lock() {
        this.locked = true;
        setTimeout(() => { this.locked = false; }, this.options.lockDuration);
    }
    /**
     * Attachs watch listeners and starts watching specified files
     * Available events are
     * `add` - Emitted when a file is created
     * `delete` - Emitted when a file is deleted
     * `change` - Emitted when a file change is detected
     * `rename` - Emitted when a file is renamed
     * `all` - Emitted for all the above events
     */
    Start() {
        this.log("Watching Files:" + os_1.EOL + this.files.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const file of this.files) {
            this.watchers.push(this.createFileWatcher(file));
        }
        this.log("Watching Directories:" + os_1.EOL + this.directories.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const dir of this.directories) {
            this.watchers.push(this.createDirWatcher(dir));
        }
        return this;
    }
}
exports.Watcher = Watcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2F0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL1dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QixtQ0FBc0M7QUFDdEMsbUNBQXNDO0FBQ3RDLHdEQUFnQztBQUVoQywyQkFBeUI7QUFDekIscUNBQTRDO0FBb0Q1QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7SUFDekIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUc7UUFDckIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBVSxFQUFFLEtBQWEsRUFBRSxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUE7Q0FDSjtBQUlELGFBQXFCLFNBQVEscUJBQVk7SUFRckM7Ozs7T0FJRztJQUNILFlBQVksV0FBOEIsRUFBRSxlQUErQixFQUFFO1FBQ3pFLEtBQUssRUFBRSxDQUFDO1FBWEYsWUFBTyxHQUFtQixFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdkksYUFBUSxHQUFvQixFQUFFLENBQUM7UUFDL0IsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixVQUFLLEdBQWtCLEVBQUUsQ0FBQztRQVNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFFcEQscUhBQXFIO1FBQ3JILElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLENB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LFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ2hHLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtZQUMzQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNwRDtRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsdUJBQXVCLEdBQUcsUUFBRyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQUcsQ0FBQyxDQUFDLENBQUM7UUFDNUcsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFO1lBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1NBQ2xEO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztDQUNKO0FBcEtELDBCQW9LQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyA9IHJlcXVpcmUoXCJmc1wiKTtcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKFwicGF0aFwiKTtcclxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50c1wiO1xyXG5pbXBvcnQgeyBzeW5jIGFzIGdsb2IgfSBmcm9tIFwiZ2xvYmJ5XCI7XHJcbmltcG9ydCBDYWxsc2l0ZSBmcm9tIFwiY2FsbHNpdGVcIjtcclxuaW1wb3J0IHsgT3B0aW9ucyBhcyBGYXN0R2xvYk9wdGlvbnMgfSBmcm9tICdmYXN0LWdsb2InO1xyXG5pbXBvcnQgeyBFT0wgfSBmcm9tIFwib3NcIjtcclxuaW1wb3J0IHtDb2xvcnMsIExlZ2FsQ29sb3J9IGZyb20gXCIuL0NvbG9yc1wiO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGU1dhdGNoT3B0aW9ucyB7XHJcbiAgICBlbmNvZGluZz86IHN0cmluZztcclxuICAgIHBlcnNpc3RlbnQ/OiBib29sZWFuO1xyXG4gICAgcmVjdXJzaXZlPzogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBXYXRjaGVyU3RydWN0IHtcclxuICAgIHRhcmdldDogc3RyaW5nO1xyXG4gICAgd2F0Y2hlcjogZnMuRlNXYXRjaGVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZTRXZlbnRMb2NrIHtcclxuICAgIGZpbGVuYW1lOiBzdHJpbmc7XHJcbiAgICBsb2NrVGltZTogbnVtYmVyO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZpbGVEZXNjcmlwdG9yIHtcclxuICAgIGJhc2VuYW1lOiBzdHJpbmc7XHJcbiAgICBmZDogbnVtYmVyO1xyXG4gICAgZGlybmFtZTogc3RyaW5nO1xyXG4gICAgYWJzb2x1dGU6IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBXYXRjaGVyT3B0aW9ucyBleHRlbmRzIEZTV2F0Y2hPcHRpb25zLCBGYXN0R2xvYk9wdGlvbnMge1xyXG4gICAgLyoqXHJcbiAgICAgKiBUaGUgZGVsYXkgaW4gbWlsbGlzZWNvbmRzIGJlZm9yZSBlbWl0dGluZyBhIG5ldyBFdmVudFxyXG4gICAgICogTm9kZUpTIGZzLndhdGNoIGVtaXRzIGR1cGxpY2F0ZSBldmVudHMgYW1vbmcgb3RoZXIgaWRpb3N5bmNyYXNlcywgdGhpcyBjb250cm9scyBob3cgbG9uZyB3ZSB3YWl0IGJlZm9yZSByZWxheWluZyBldmVudHNcclxuICAgICAqIEBkZWZhdWx0IDUwMDBcclxuICAgICAqL1xyXG4gICAgbG9ja0R1cmF0aW9uPzogbnVtYmVyO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogRW5hYmxlcyB2ZXJib3NlIGxvZ2dpbmdcclxuICAgICAqIEBkZWZhdWx0IGZhbHNlXHJcbiAgICAgKi9cclxuICAgIHZlcmJvc2U/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERlc2NyaXB0b3JEaXJlY3Rvcnkge1xyXG4gICAgZGlybmFtZTogc3RyaW5nO1xyXG4gICAgZGVzY3JpcHRvcnM6IEZpbGVEZXNjcmlwdG9yW107XHJcbn1cclxuXHJcbi8vIEFkZCB0aGUgdW5pcXVlIGV4dGVuc2lvbiBtZXRob2QgdG8gdGhlIEFycmF5IHByb3RvdHlwZVxyXG5kZWNsYXJlIGdsb2JhbCB7XHJcbiAgICBpbnRlcmZhY2UgQXJyYXk8VD4ge1xyXG4gICAgICAgIHVuaXF1ZTogKCkgPT4gQXJyYXk8VD47XHJcbiAgICB9XHJcbn1cclxuXHJcbmlmICghQXJyYXkucHJvdG90eXBlLnVuaXF1ZSkge1xyXG4gICAgQXJyYXkucHJvdG90eXBlLnVuaXF1ZSA9IGZ1bmN0aW9uICgpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5maWx0ZXIoKHZhbHVlOiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcclxuICAgICAgICAgICAgcmV0dXJuIHRoaXMuaW5kZXhPZih2YWx1ZSkgPT09IGluZGV4O1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG59XHJcblxyXG5leHBvcnQgdHlwZSBMZWdhbEV2ZW50cyA9IFwiYWRkXCIgfCBcImRlbGV0ZVwiIHwgXCJjaGFuZ2VcIiB8IFwicmVuYW1lXCIgfCBcImFsbFwiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFdhdGNoZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xyXG4gICAgcHJvdGVjdGVkIGZpbGVzOiBzdHJpbmdbXTtcclxuICAgIHByb3RlY3RlZCBkaXJlY3Rvcmllczogc3RyaW5nW107XHJcbiAgICBwcm90ZWN0ZWQgb3B0aW9uczogV2F0Y2hlck9wdGlvbnMgPSB7IGxvY2tEdXJhdGlvbjogMTAwMCwgYWJzb2x1dGU6IHRydWUsIGVuY29kaW5nOiBcInV0Zi04XCIsIHBlcnNpc3RlbnQ6IHRydWUsIHJlY3Vyc2l2ZTogdHJ1ZSwgdmVyYm9zZTogZmFsc2UgfTtcclxuICAgIHByb3RlY3RlZCB3YXRjaGVyczogV2F0Y2hlclN0cnVjdFtdID0gW107XHJcbiAgICBwcm90ZWN0ZWQgbG9ja2VkOiBib29sZWFuID0gZmFsc2U7XHJcbiAgICBwcm90ZWN0ZWQgbG9ja3M6IEZTRXZlbnRMb2NrW10gPSBbXTtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEZpbGUgV2F0Y2hpbmcgdXNpbmcgTm9kZUpTIGZzLndhdGNoXHJcbiAgICAgKiBAcGFyYW0gZ2xvYlBhdHRlcm4gVGhlIGdsb2Igb3IgYXJyYXkgb2YgZ2xvYnMgdG8gbWF0Y2ggYWdhaW5zdFxyXG4gICAgICogQHBhcmFtIHdhdGNoT3B0aW9ucyBPcHRpb25zIG9iamVjdCBcclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IoZ2xvYlBhdHRlcm46IHN0cmluZyB8IHN0cmluZ1tdLCB3YXRjaE9wdGlvbnM6IFdhdGNoZXJPcHRpb25zID0ge30pIHtcclxuICAgICAgICBzdXBlcigpO1xyXG4gICAgICAgIHRoaXMub3B0aW9ucyA9IHsgLi4udGhpcy5vcHRpb25zLCAuLi53YXRjaE9wdGlvbnMgfTtcclxuXHJcbiAgICAgICAgLy8gQ2FsbHNpdGUgR2V0cyB0aGUgZGlyZWN0b3J5IG9mIHRoZSBmaWxlIHRoaXMgY29uc3RydWN0b3Igd2FzIGNhbGxlZCBmcm9tIHNvIHdlIGNhbiBnbG9iIGZyb20gdGhlcmUgaW5zdGVhZCBvZiBoZXJlXHJcbiAgICAgICAgdGhpcy5vcHRpb25zLmN3ZCA9ICh0eXBlb2YgdGhpcy5vcHRpb25zLmN3ZCA9PT0gXCJ1bmRlZmluZWRcIikgPyBwYXRoLmRpcm5hbWUoQ2FsbHNpdGUoKVsxXS5nZXRGaWxlTmFtZSgpKSA6IHRoaXMub3B0aW9ucy5jd2Q7XHJcblxyXG4gICAgICAgIHRoaXMuZmlsZXMgPSB0aGlzLmdsb2JGaWxlcyhnbG9iUGF0dGVybikubWFwKChnKSA9PiBwYXRoLm5vcm1hbGl6ZShnKSk7XHJcbiAgICAgICAgdGhpcy5kaXJlY3RvcmllcyA9IHRoaXMuZmlsZXMubWFwKChmKSA9PiBwYXRoLmRpcm5hbWUoZikpLnVuaXF1ZSgpO1xyXG5cclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGxvZyguLi5sb2dhcmdzOiBhbnlbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmVyYm9zZSkge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtFT0x9JHtDb2xvcnMoYFJlbG9hZFdhdGNoZXI6OiR7Q2FsbHNpdGUoKVsxXS5nZXRGdW5jdGlvbk5hbWUoKX1gLCBcInllbGxvd1wiKSB9YCwgLi4ubG9nYXJncywgRU9MKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdsb2JGaWxlcyhnbG9iUGF0dGVybjogc3RyaW5nIHwgc3RyaW5nW10pOiBzdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIGdsb2IoZ2xvYlBhdHRlcm4sIHRoaXMub3B0aW9ucyk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGlzRGlyZWN0b3J5KHNvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuIGZzLmxzdGF0U3luYyhzb3VyY2UpLmlzRGlyZWN0b3J5KCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGlzRmlsZShzb3VyY2U6IHN0cmluZyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhZnMubHN0YXRTeW5jKHNvdXJjZSkuaXNEaXJlY3RvcnkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2V0RGlyZWN0b3JpZXMoc291cmNlOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKHNvdXJjZSkubWFwKChuYW1lOiBzdHJpbmcpID0+IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihzb3VyY2UsIG5hbWUpKSkuZmlsdGVyKHRoaXMuaXNEaXJlY3RvcnkpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRGaWxlcyhkaXI6IHN0cmluZyk6c3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiBmcy5yZWFkZGlyU3luYyhkaXIpLm1hcCgobmFtZTogc3RyaW5nKSA9PiBwYXRoLm5vcm1hbGl6ZShwYXRoLmpvaW4oZGlyLCBuYW1lKSkpLmZpbHRlcih0aGlzLmlzRmlsZSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIG9uV2F0Y2hFdmVudEZpbGUoZTogc3RyaW5nLCBmOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5sb2NrZWQgfHwgZSAhPT0gXCJjaGFuZ2VcIikgeyByZXR1cm47IH1cclxuICAgICAgICB0aGlzLmxvY2soKTtcclxuXHJcbiAgICAgICAgdGhpcy5sb2coXCJOb2RlLmpzIEZTRXZlbnQ6XCIsIGUsIFwiTm9kZSBGU0V2ZW50IEZpbGU6XCIsIGYpO1xyXG4gICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBmKTtcclxuICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIiwgZik7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBmcy53YXRjaCBldmVudCBoYW5kbGVyIGZvciBkaXJlY3Rvcmllc1xyXG4gICAgICogV2Ugd2F0Y2ggZGlyZWN0b3JpZXMgZm9yIGFkZCwgcmVuYW1lIGRlbGV0ZSBldmVudHMgc28gd2UgY2FuIGFkZCBhbmQgcmVtb3ZlIG5ldyBsaXN0ZW5lcnMgYXMgbmVjZXNzYXJ5XHJcbiAgICAgKiBcclxuICAgICAqIEBwYXJhbSBlIHtzdHJpbmd9IGV2ZW50IHR5cGVcclxuICAgICAqIEBwYXJhbSBmIHtzdHJpbmd9IGZpbGVcclxuICAgICAqIEBwYXJhbSBkaXIge3N0cmluZ30gdGhlIGRpcmVjdG9yeVxyXG4gICAgICovXHJcbiAgICBwcm90ZWN0ZWQgb25XYXRjaEV2ZW50RGlyKGU6IHN0cmluZywgZjogc3RyaW5nLCBkaXI6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2tlZCB8fCBlICE9PSBcInJlbmFtZVwiKSB7IHJldHVybjsgfVxyXG4gICAgICAgIHRoaXMubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhcIk5vZGUuanMgRlNFdmVudDpcIiwgZSwgXCJOb2RlIEZTRXZlbnQgRmlsZTpcIiwgZiwgXCJEaXJlY3Rvcnk6XCIsIGRpcik7XHJcbiAgICAgICAgY29uc3QgYWJzID0gcGF0aC5qb2luKGRpciwgcGF0aC5iYXNlbmFtZShmKSk7XHJcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGFicykpIHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IHJlbmFtZWRGaWxlID0gdGhpcy5nZXRSZW5hbWVkKGRpcik7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuYW1lZEZpbGUgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKGBPbGQgRmlsZTogJHthYnN9YClcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKGBSZW5hbWVkIEZpbGU6ICR7cmVuYW1lZEZpbGV9YClcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInJlbmFtZVwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlV2F0Y2hlcihhYnMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGFicyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJkZWxldGVcIiwgYWJzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghdGhpcy5maWxlcy5pbmNsdWRlcyhhYnMpKSB7XHJcbiAgICAgICAgICAgIC8vIENyZWF0ZVxyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2godGhpcy5jcmVhdGVGaWxlV2F0Y2hlcihhYnMpKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGFicyk7XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdChcImFkZFwiLCBhYnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVtb3ZlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB3YXRjaGVyU3RydWN0ID0gdGhpcy5nZXRXYXRjaGVyKGZpbGUpO1xyXG4gICAgICAgIGlmICh0eXBlb2Ygd2F0Y2hlclN0cnVjdCAhPT0gXCJ1bmRlZmluZWRcIikgeyBcclxuICAgICAgICAgICAgd2F0Y2hlclN0cnVjdC53YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMuc3BsaWNlKHRoaXMud2F0Y2hlcnMuaW5kZXhPZih3YXRjaGVyU3RydWN0KSwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRSZW5hbWVkKGRpcjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBGTl9OQU1FID0gXCJpc1JlbmFtZVwiO1xyXG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5nZXRGaWxlcyhkaXIpO1xyXG4gICAgICAgIHRoaXMubG9nKFwiRGlzayBGaWxlczpcIiwgZmlsZXMpO1xyXG4gICAgICAgIHRoaXMubG9nKFwiV2F0Y2hlZCBGaWxlc1wiLCB0aGlzLmZpbGVzKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGYgb2YgZmlsZXMpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpbGVzLmluY2x1ZGVzKGYpKSB7IHJldHVybiBmOyB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjcmVhdGVGaWxlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0YXJnZXQ6IGZpbGUsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGZpbGUsIHRoaXMub3B0aW9ucywgKGU6IHN0cmluZywgXykgPT4geyB0aGlzLm9uV2F0Y2hFdmVudEZpbGUoZSwgZmlsZSk7IH0pXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHByb3RlY3RlZCBjcmVhdGVEaXJXYXRjaGVyKGRpcjogc3RyaW5nKTogV2F0Y2hlclN0cnVjdCB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGFyZ2V0OiBkaXIsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGRpciwgdGhpcy5vcHRpb25zLCAoZTogc3RyaW5nLCBmOiBzdHJpbmcpID0+IHsgdGhpcy5vbldhdGNoRXZlbnREaXIoZSwgZiwgZGlyKTsgfSlcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRXYXRjaGVyKGZpbGVuYW1lOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4gdGhpcy53YXRjaGVycy5maW5kKCh3KSA9PiBwYXRoLm5vcm1hbGl6ZSh3LnRhcmdldCkgPT09IHBhdGgubm9ybWFsaXplKGZpbGVuYW1lKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByb3RlY3RlZCBsb2NrKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5sb2NrZWQgPSBmYWxzZTsgfSwgdGhpcy5vcHRpb25zLmxvY2tEdXJhdGlvbik7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXR0YWNocyB3YXRjaCBsaXN0ZW5lcnMgYW5kIHN0YXJ0cyB3YXRjaGluZyBzcGVjaWZpZWQgZmlsZXNcclxuICAgICAqIEF2YWlsYWJsZSBldmVudHMgYXJlIFxyXG4gICAgICogYGFkZGAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIGNyZWF0ZWRcclxuICAgICAqIGBkZWxldGVgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBpcyBkZWxldGVkXHJcbiAgICAgKiBgY2hhbmdlYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgY2hhbmdlIGlzIGRldGVjdGVkIFxyXG4gICAgICogYHJlbmFtZWAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIHJlbmFtZWRcclxuICAgICAqIGBhbGxgIC0gRW1pdHRlZCBmb3IgYWxsIHRoZSBhYm92ZSBldmVudHNcclxuICAgICAqL1xyXG4gICAgcHVibGljIFN0YXJ0KCk6IHRoaXMge1xyXG4gICAgICAgIHRoaXMubG9nKFwiV2F0Y2hpbmcgRmlsZXM6XCIgKyBFT0wgKyB0aGlzLmZpbGVzLm1hcCgoZikgPT4gYFxcdTAwMWJbMzJtJHtmfVxcdTAwMWJbMzltYCkuam9pbihFT0wpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGZpbGUgb2YgdGhpcy5maWxlcykge1xyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2godGhpcy5jcmVhdGVGaWxlV2F0Y2hlcihmaWxlKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMubG9nKFwiV2F0Y2hpbmcgRGlyZWN0b3JpZXM6XCIgKyBFT0wgKyB0aGlzLmRpcmVjdG9yaWVzLm1hcCgoZikgPT4gYFxcdTAwMWJbMzJtJHtmfVxcdTAwMWJbMzltYCkuam9pbihFT0wpKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGRpciBvZiB0aGlzLmRpcmVjdG9yaWVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZURpcldhdGNoZXIoZGlyKSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxufVxyXG4iXX0=