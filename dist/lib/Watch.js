"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const events_1 = require("events");
const globby_1 = require("globby");
const callsite_1 = __importDefault(require("callsite"));
const os_1 = require("os");
const Colors_1 = require("./Colors");
if (!Array.prototype.unique) {
    Array.prototype.unique = function () {
        return this.filter((value, index) => {
            return this.indexOf(value) === index;
        });
    };
}
class Watcher extends events_1.EventEmitter {
    /**
     * File Watching using NodeJS fs.watch
     * @param globPattern The glob or array of globs to match against
     * @param watchOptions Options object
     */
    constructor(globPattern, watchOptions = {}) {
        super();
        this.options = { lockDuration: 1000, absolute: true, encoding: "utf-8", persistent: true, recursive: true, verbose: false };
        this.watchers = [];
        this.locked = false;
        this.locks = [];
        this.options = { ...this.options, ...watchOptions };
        // Callsite Gets the directory of the file this constructor was called from so we can glob from there instead of here
        this.options.cwd = (typeof this.options.cwd === "undefined") ? path.dirname(callsite_1.default()[1].getFileName()) : this.options.cwd;
        this.log("Working Directory", this.options.cwd);
        this.log("Options", this.options);
        this.files = this.globFiles(globPattern).map((g) => path.normalize(g));
        this.directories = this.files.map((f) => path.dirname(f)).unique();
    }
    log(...logargs) {
        if (this.options.verbose) {
            // tslint:disable-next-line:no-console
            console.log(`${Colors_1.Colors(`ReloadWatcher::${callsite_1.default()[1].getFunctionName()}`, "cyan")}`, ...logargs, os_1.EOL);
        }
    }
    globFiles(globPattern) {
        return globby_1.sync(globPattern, this.options);
    }
    isDirectory(source) {
        return fs.lstatSync(source).isDirectory();
    }
    isFile(source) {
        return !fs.lstatSync(source).isDirectory();
    }
    getDirectories(source) {
        return fs.readdirSync(source).map((name) => path.normalize(path.join(source, name))).filter(this.isDirectory);
    }
    getFiles(dir) {
        return fs.readdirSync(dir).map((name) => path.normalize(path.join(dir, name))).filter(this.isFile);
    }
    onWatchEventFile(e, f) {
        if (this.locked || e !== "change") {
            return;
        }
        this.lock();
        this.log("Node.js FSEvent:", e, "Node FSEvent File:", f);
        this.emit("all", f);
        this.emit("change", f);
    }
    /**
     * fs.watch event handler for directories
     * We watch directories for add, rename delete events so we can add and remove new listeners as necessary
     *
     * @param e {string} event type
     * @param f {string} file
     * @param dir {string} the directory
     */
    onWatchEventDir(e, f, dir) {
        if (this.locked || e !== "rename") {
            return;
        }
        this.lock();
        this.log("Node.js FSEvent:", e, "Node FSEvent File:", f, "Directory:", dir);
        const abs = path.join(dir, path.basename(f));
        if (!fs.existsSync(abs)) {
            const renamedFile = this.getRenamed(dir);
            if (typeof renamedFile !== "undefined") {
                this.log(`Old File: ${abs}`);
                this.log(`Renamed File: ${renamedFile}`);
                this.emit("all", abs, renamedFile);
                this.emit("rename", abs, renamedFile);
                this.removeWatcher(abs);
            }
            else {
                this.emit("all", abs);
                this.emit("delete", abs);
            }
            return;
        }
        if (!this.files.includes(abs)) {
            // Create
            this.watchers.push(this.createFileWatcher(abs));
            this.emit("all", abs);
            this.emit("add", abs);
        }
    }
    removeWatcher(file) {
        const watcherStruct = this.getWatcher(file);
        if (typeof watcherStruct !== "undefined") {
            watcherStruct.watcher.close();
            this.watchers.splice(this.watchers.indexOf(watcherStruct), 1);
        }
    }
    getRenamed(dir) {
        const FN_NAME = "isRename";
        const files = this.getFiles(dir);
        this.log("Disk Files:", files);
        this.log("Watched Files", this.files);
        for (const f of files) {
            if (!this.files.includes(f)) {
                return f;
            }
        }
        return undefined;
    }
    createFileWatcher(file) {
        return {
            target: file,
            watcher: fs.watch(file, this.options, (e, _) => { this.onWatchEventFile(e, file); })
        };
    }
    createDirWatcher(dir) {
        return {
            target: dir,
            watcher: fs.watch(dir, this.options, (e, f) => { this.onWatchEventDir(e, f, dir); })
        };
    }
    getWatcher(filename) {
        return this.watchers.find((w) => path.normalize(w.target) === path.normalize(filename));
    }
    lock() {
        this.locked = true;
        setTimeout(() => { this.locked = false; }, this.options.lockDuration);
    }
    /**
     * Attachs watch listeners and starts watching specified files
     * Available events are
     * `add` - Emitted when a file is created
     * `delete` - Emitted when a file is deleted
     * `change` - Emitted when a file change is detected
     * `rename` - Emitted when a file is renamed
     * `all` - Emitted for all the above events
     */
    Start() {
        this.log("Watching Files:" + os_1.EOL + this.files.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const file of this.files) {
            this.watchers.push(this.createFileWatcher(file));
        }
        this.log("Watching Directories:" + os_1.EOL + this.directories.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const dir of this.directories) {
            this.watchers.push(this.createDirWatcher(dir));
        }
        return this;
    }
}
exports.Watcher = Watcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2F0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL1dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QixtQ0FBc0M7QUFDdEMsbUNBQXNDO0FBQ3RDLHdEQUFnQztBQUVoQywyQkFBeUI7QUFDekIscUNBQTRDO0FBb0Q1QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7SUFDekIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUc7UUFDckIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBVSxFQUFFLEtBQWEsRUFBRSxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUE7Q0FDSjtBQUlELGFBQXFCLFNBQVEscUJBQVk7SUFRckM7Ozs7T0FJRztJQUNILFlBQVksV0FBOEIsRUFBRSxlQUErQixFQUFFO1FBQ3pFLEtBQUssRUFBRSxDQUFDO1FBWEYsWUFBTyxHQUFtQixFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdkksYUFBUSxHQUFvQixFQUFFLENBQUM7UUFDL0IsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixVQUFLLEdBQWtCLEVBQUUsQ0FBQztRQVNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFFcEQscUhBQXFIO1FBQ3JILElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLENB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UUc7SUFDSSxLQUFLO1FBQ1IsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsR0FBRyxRQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBRyxDQUFDLENBQUMsQ0FBQztRQUNoRyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDcEQ7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLHVCQUF1QixHQUFHLFFBQUcsR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFHLENBQUMsQ0FBQyxDQUFDO1FBQzVHLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRTtZQUNoQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztTQUNsRDtRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7Q0FDSjtBQXZLRCwwQkF1S0MiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZnMgPSByZXF1aXJlKFwiZnNcIik7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZShcInBhdGhcIik7XHJcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gXCJldmVudHNcIjtcclxuaW1wb3J0IHsgc3luYyBhcyBnbG9iIH0gZnJvbSBcImdsb2JieVwiO1xyXG5pbXBvcnQgQ2FsbHNpdGUgZnJvbSBcImNhbGxzaXRlXCI7XHJcbmltcG9ydCB7IE9wdGlvbnMgYXMgRmFzdEdsb2JPcHRpb25zIH0gZnJvbSAnZmFzdC1nbG9iJztcclxuaW1wb3J0IHsgRU9MIH0gZnJvbSBcIm9zXCI7XHJcbmltcG9ydCB7Q29sb3JzLCBMZWdhbENvbG9yfSBmcm9tIFwiLi9Db2xvcnNcIjtcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRlNXYXRjaE9wdGlvbnMge1xyXG4gICAgZW5jb2Rpbmc/OiBzdHJpbmc7XHJcbiAgICBwZXJzaXN0ZW50PzogYm9vbGVhbjtcclxuICAgIHJlY3Vyc2l2ZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgV2F0Y2hlclN0cnVjdCB7XHJcbiAgICB0YXJnZXQ6IHN0cmluZztcclxuICAgIHdhdGNoZXI6IGZzLkZTV2F0Y2hlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGU0V2ZW50TG9jayB7XHJcbiAgICBmaWxlbmFtZTogc3RyaW5nO1xyXG4gICAgbG9ja1RpbWU6IG51bWJlcjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBGaWxlRGVzY3JpcHRvciB7XHJcbiAgICBiYXNlbmFtZTogc3RyaW5nO1xyXG4gICAgZmQ6IG51bWJlcjtcclxuICAgIGRpcm5hbWU6IHN0cmluZztcclxuICAgIGFic29sdXRlOiBzdHJpbmc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgV2F0Y2hlck9wdGlvbnMgZXh0ZW5kcyBGU1dhdGNoT3B0aW9ucywgRmFzdEdsb2JPcHRpb25zIHtcclxuICAgIC8qKlxyXG4gICAgICogVGhlIGRlbGF5IGluIG1pbGxpc2Vjb25kcyBiZWZvcmUgZW1pdHRpbmcgYSBuZXcgRXZlbnRcclxuICAgICAqIE5vZGVKUyBmcy53YXRjaCBlbWl0cyBkdXBsaWNhdGUgZXZlbnRzIGFtb25nIG90aGVyIGlkaW9zeW5jcmFzZXMsIHRoaXMgY29udHJvbHMgaG93IGxvbmcgd2Ugd2FpdCBiZWZvcmUgcmVsYXlpbmcgZXZlbnRzXHJcbiAgICAgKiBAZGVmYXVsdCA1MDAwXHJcbiAgICAgKi9cclxuICAgIGxvY2tEdXJhdGlvbj86IG51bWJlcjtcclxuXHJcbiAgICAvKipcclxuICAgICAqIEVuYWJsZXMgdmVyYm9zZSBsb2dnaW5nXHJcbiAgICAgKiBAZGVmYXVsdCBmYWxzZVxyXG4gICAgICovXHJcbiAgICB2ZXJib3NlPzogYm9vbGVhbjtcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEZXNjcmlwdG9yRGlyZWN0b3J5IHtcclxuICAgIGRpcm5hbWU6IHN0cmluZztcclxuICAgIGRlc2NyaXB0b3JzOiBGaWxlRGVzY3JpcHRvcltdO1xyXG59XHJcblxyXG4vLyBBZGQgdGhlIHVuaXF1ZSBleHRlbnNpb24gbWV0aG9kIHRvIHRoZSBBcnJheSBwcm90b3R5cGVcclxuZGVjbGFyZSBnbG9iYWwge1xyXG4gICAgaW50ZXJmYWNlIEFycmF5PFQ+IHtcclxuICAgICAgICB1bmlxdWU6ICgpID0+IEFycmF5PFQ+O1xyXG4gICAgfVxyXG59XHJcblxyXG5pZiAoIUFycmF5LnByb3RvdHlwZS51bmlxdWUpIHtcclxuICAgIEFycmF5LnByb3RvdHlwZS51bmlxdWUgPSBmdW5jdGlvbiAoKSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuZmlsdGVyKCh2YWx1ZTogYW55LCBpbmRleDogbnVtYmVyKSA9PiB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLmluZGV4T2YodmFsdWUpID09PSBpbmRleDtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxufVxyXG5cclxuZXhwb3J0IHR5cGUgTGVnYWxFdmVudHMgPSBcImFkZFwiIHwgXCJkZWxldGVcIiB8IFwiY2hhbmdlXCIgfCBcInJlbmFtZVwiIHwgXCJhbGxcIjtcclxuXHJcbmV4cG9ydCBjbGFzcyBXYXRjaGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcclxuICAgIHByb3RlY3RlZCBmaWxlczogc3RyaW5nW107XHJcbiAgICBwcm90ZWN0ZWQgZGlyZWN0b3JpZXM6IHN0cmluZ1tdO1xyXG4gICAgcHJvdGVjdGVkIG9wdGlvbnM6IFdhdGNoZXJPcHRpb25zID0geyBsb2NrRHVyYXRpb246IDEwMDAsIGFic29sdXRlOiB0cnVlLCBlbmNvZGluZzogXCJ1dGYtOFwiLCBwZXJzaXN0ZW50OiB0cnVlLCByZWN1cnNpdmU6IHRydWUsIHZlcmJvc2U6IGZhbHNlIH07XHJcbiAgICBwcm90ZWN0ZWQgd2F0Y2hlcnM6IFdhdGNoZXJTdHJ1Y3RbXSA9IFtdO1xyXG4gICAgcHJvdGVjdGVkIGxvY2tlZDogYm9vbGVhbiA9IGZhbHNlO1xyXG4gICAgcHJvdGVjdGVkIGxvY2tzOiBGU0V2ZW50TG9ja1tdID0gW107XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBGaWxlIFdhdGNoaW5nIHVzaW5nIE5vZGVKUyBmcy53YXRjaFxyXG4gICAgICogQHBhcmFtIGdsb2JQYXR0ZXJuIFRoZSBnbG9iIG9yIGFycmF5IG9mIGdsb2JzIHRvIG1hdGNoIGFnYWluc3RcclxuICAgICAqIEBwYXJhbSB3YXRjaE9wdGlvbnMgT3B0aW9ucyBvYmplY3QgXHJcbiAgICAgKi9cclxuICAgIGNvbnN0cnVjdG9yKGdsb2JQYXR0ZXJuOiBzdHJpbmcgfCBzdHJpbmdbXSwgd2F0Y2hPcHRpb25zOiBXYXRjaGVyT3B0aW9ucyA9IHt9KSB7XHJcbiAgICAgICAgc3VwZXIoKTtcclxuICAgICAgICB0aGlzLm9wdGlvbnMgPSB7IC4uLnRoaXMub3B0aW9ucywgLi4ud2F0Y2hPcHRpb25zIH07XHJcblxyXG4gICAgICAgIC8vIENhbGxzaXRlIEdldHMgdGhlIGRpcmVjdG9yeSBvZiB0aGUgZmlsZSB0aGlzIGNvbnN0cnVjdG9yIHdhcyBjYWxsZWQgZnJvbSBzbyB3ZSBjYW4gZ2xvYiBmcm9tIHRoZXJlIGluc3RlYWQgb2YgaGVyZVxyXG4gICAgICAgIHRoaXMub3B0aW9ucy5jd2QgPSAodHlwZW9mIHRoaXMub3B0aW9ucy5jd2QgPT09IFwidW5kZWZpbmVkXCIpID8gcGF0aC5kaXJuYW1lKENhbGxzaXRlKClbMV0uZ2V0RmlsZU5hbWUoKSkgOiB0aGlzLm9wdGlvbnMuY3dkO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhcIldvcmtpbmcgRGlyZWN0b3J5XCIsIHRoaXMub3B0aW9ucy5jd2QpO1xyXG4gICAgICAgIHRoaXMubG9nKFwiT3B0aW9uc1wiLCB0aGlzLm9wdGlvbnMpO1xyXG5cclxuICAgICAgICB0aGlzLmZpbGVzID0gdGhpcy5nbG9iRmlsZXMoZ2xvYlBhdHRlcm4pLm1hcCgoZykgPT4gcGF0aC5ub3JtYWxpemUoZykpO1xyXG4gICAgICAgIHRoaXMuZGlyZWN0b3JpZXMgPSB0aGlzLmZpbGVzLm1hcCgoZikgPT4gcGF0aC5kaXJuYW1lKGYpKS51bmlxdWUoKTtcclxuXHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBsb2coLi4ubG9nYXJnczogYW55W10pOiB2b2lkIHtcclxuICAgICAgICBpZiAodGhpcy5vcHRpb25zLnZlcmJvc2UpIHtcclxuICAgICAgICAgICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm5vLWNvbnNvbGVcclxuICAgICAgICAgICAgY29uc29sZS5sb2coYCR7Q29sb3JzKGBSZWxvYWRXYXRjaGVyOjoke0NhbGxzaXRlKClbMV0uZ2V0RnVuY3Rpb25OYW1lKCl9YCwgXCJjeWFuXCIpIH1gLCAuLi5sb2dhcmdzLCBFT0wpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2xvYkZpbGVzKGdsb2JQYXR0ZXJuOiBzdHJpbmcgfCBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZ2xvYihnbG9iUGF0dGVybiwgdGhpcy5vcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNEaXJlY3Rvcnkoc291cmNlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gZnMubHN0YXRTeW5jKHNvdXJjZSkuaXNEaXJlY3RvcnkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNGaWxlKHNvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICFmcy5sc3RhdFN5bmMoc291cmNlKS5pc0RpcmVjdG9yeSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXREaXJlY3Rvcmllcyhzb3VyY2U6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZnMucmVhZGRpclN5bmMoc291cmNlKS5tYXAoKG5hbWU6IHN0cmluZykgPT4gcGF0aC5ub3JtYWxpemUocGF0aC5qb2luKHNvdXJjZSwgbmFtZSkpKS5maWx0ZXIodGhpcy5pc0RpcmVjdG9yeSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldEZpbGVzKGRpcjogc3RyaW5nKTpzdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKGRpcikubWFwKChuYW1lOiBzdHJpbmcpID0+IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihkaXIsIG5hbWUpKSkuZmlsdGVyKHRoaXMuaXNGaWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgb25XYXRjaEV2ZW50RmlsZShlOiBzdHJpbmcsIGY6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2tlZCB8fCBlICE9PSBcImNoYW5nZVwiKSB7IHJldHVybjsgfVxyXG4gICAgICAgIHRoaXMubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhcIk5vZGUuanMgRlNFdmVudDpcIiwgZSwgXCJOb2RlIEZTRXZlbnQgRmlsZTpcIiwgZik7XHJcbiAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGYpO1xyXG4gICAgICAgIHRoaXMuZW1pdChcImNoYW5nZVwiLCBmKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGZzLndhdGNoIGV2ZW50IGhhbmRsZXIgZm9yIGRpcmVjdG9yaWVzXHJcbiAgICAgKiBXZSB3YXRjaCBkaXJlY3RvcmllcyBmb3IgYWRkLCByZW5hbWUgZGVsZXRlIGV2ZW50cyBzbyB3ZSBjYW4gYWRkIGFuZCByZW1vdmUgbmV3IGxpc3RlbmVycyBhcyBuZWNlc3NhcnlcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGUge3N0cmluZ30gZXZlbnQgdHlwZVxyXG4gICAgICogQHBhcmFtIGYge3N0cmluZ30gZmlsZVxyXG4gICAgICogQHBhcmFtIGRpciB7c3RyaW5nfSB0aGUgZGlyZWN0b3J5XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBvbldhdGNoRXZlbnREaXIoZTogc3RyaW5nLCBmOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgaWYgKHRoaXMubG9ja2VkIHx8IGUgIT09IFwicmVuYW1lXCIpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgdGhpcy5sb2NrKCk7XHJcblxyXG4gICAgICAgIHRoaXMubG9nKFwiTm9kZS5qcyBGU0V2ZW50OlwiLCBlLCBcIk5vZGUgRlNFdmVudCBGaWxlOlwiLCBmLCBcIkRpcmVjdG9yeTpcIiwgZGlyKTtcclxuICAgICAgICBjb25zdCBhYnMgPSBwYXRoLmpvaW4oZGlyLCBwYXRoLmJhc2VuYW1lKGYpKTtcclxuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMoYWJzKSkge1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgY29uc3QgcmVuYW1lZEZpbGUgPSB0aGlzLmdldFJlbmFtZWQoZGlyKTtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiByZW5hbWVkRmlsZSAhPT0gXCJ1bmRlZmluZWRcIikge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2coYE9sZCBGaWxlOiAke2Fic31gKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5sb2coYFJlbmFtZWQgRmlsZTogJHtyZW5hbWVkRmlsZX1gKVxyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGFicywgcmVuYW1lZEZpbGUpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwicmVuYW1lXCIsIGFicywgcmVuYW1lZEZpbGUpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVXYXRjaGVyKGFicyk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJhbGxcIiwgYWJzKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcImRlbGV0ZVwiLCBhYnMpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICB9XHJcbiAgICAgICAgXHJcbiAgICAgICAgaWYgKCF0aGlzLmZpbGVzLmluY2x1ZGVzKGFicykpIHtcclxuICAgICAgICAgICAgLy8gQ3JlYXRlXHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZUZpbGVXYXRjaGVyKGFicykpO1xyXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJhbGxcIiwgYWJzKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWRkXCIsIGFicyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCByZW1vdmVXYXRjaGVyKGZpbGU6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IHdhdGNoZXJTdHJ1Y3QgPSB0aGlzLmdldFdhdGNoZXIoZmlsZSk7XHJcbiAgICAgICAgaWYgKHR5cGVvZiB3YXRjaGVyU3RydWN0ICE9PSBcInVuZGVmaW5lZFwiKSB7IFxyXG4gICAgICAgICAgICB3YXRjaGVyU3RydWN0LndhdGNoZXIuY2xvc2UoKTtcclxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5zcGxpY2UodGhpcy53YXRjaGVycy5pbmRleE9mKHdhdGNoZXJTdHJ1Y3QpLCAxKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldFJlbmFtZWQoZGlyOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IEZOX05BTUUgPSBcImlzUmVuYW1lXCI7XHJcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdldEZpbGVzKGRpcik7XHJcbiAgICAgICAgdGhpcy5sb2coXCJEaXNrIEZpbGVzOlwiLCBmaWxlcyk7XHJcbiAgICAgICAgdGhpcy5sb2coXCJXYXRjaGVkIEZpbGVzXCIsIHRoaXMuZmlsZXMpO1xyXG4gICAgICAgIGZvciAoY29uc3QgZiBvZiBmaWxlcykge1xyXG4gICAgICAgICAgICBpZiAoIXRoaXMuZmlsZXMuaW5jbHVkZXMoZikpIHsgcmV0dXJuIGY7IH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDtcclxuXHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGNyZWF0ZUZpbGVXYXRjaGVyKGZpbGU6IHN0cmluZyk6IFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgIHRhcmdldDogZmlsZSxcclxuICAgICAgICAgICAgd2F0Y2hlcjogZnMud2F0Y2goZmlsZSwgdGhpcy5vcHRpb25zLCAoZTogc3RyaW5nLCBfKSA9PiB7IHRoaXMub25XYXRjaEV2ZW50RmlsZShlLCBmaWxlKTsgfSlcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG4gICAgcHJvdGVjdGVkIGNyZWF0ZURpcldhdGNoZXIoZGlyOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0YXJnZXQ6IGRpcixcclxuICAgICAgICAgICAgd2F0Y2hlcjogZnMud2F0Y2goZGlyLCB0aGlzLm9wdGlvbnMsIChlOiBzdHJpbmcsIGY6IHN0cmluZykgPT4geyB0aGlzLm9uV2F0Y2hFdmVudERpcihlLCBmLCBkaXIpOyB9KVxyXG4gICAgICAgIH07XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldFdhdGNoZXIoZmlsZW5hbWU6IHN0cmluZyk6IFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgICAgIHJldHVybiB0aGlzLndhdGNoZXJzLmZpbmQoKHcpID0+IHBhdGgubm9ybWFsaXplKHcudGFyZ2V0KSA9PT0gcGF0aC5ub3JtYWxpemUoZmlsZW5hbWUpKTtcclxuICAgIH1cclxuICAgIFxyXG4gICAgcHJvdGVjdGVkIGxvY2soKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5sb2NrZWQgPSB0cnVlO1xyXG4gICAgICAgIHNldFRpbWVvdXQoKCkgPT4geyB0aGlzLmxvY2tlZCA9IGZhbHNlOyB9LCB0aGlzLm9wdGlvbnMubG9ja0R1cmF0aW9uKTtcclxuICAgIH1cclxuXHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBdHRhY2hzIHdhdGNoIGxpc3RlbmVycyBhbmQgc3RhcnRzIHdhdGNoaW5nIHNwZWNpZmllZCBmaWxlc1xyXG4gICAgICogQXZhaWxhYmxlIGV2ZW50cyBhcmUgXHJcbiAgICAgKiBgYWRkYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgaXMgY3JlYXRlZFxyXG4gICAgICogYGRlbGV0ZWAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIGRlbGV0ZWRcclxuICAgICAqIGBjaGFuZ2VgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBjaGFuZ2UgaXMgZGV0ZWN0ZWQgXHJcbiAgICAgKiBgcmVuYW1lYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgaXMgcmVuYW1lZFxyXG4gICAgICogYGFsbGAgLSBFbWl0dGVkIGZvciBhbGwgdGhlIGFib3ZlIGV2ZW50c1xyXG4gICAgICovXHJcbiAgICBwdWJsaWMgU3RhcnQoKTogdGhpcyB7XHJcbiAgICAgICAgdGhpcy5sb2coXCJXYXRjaGluZyBGaWxlczpcIiArIEVPTCArIHRoaXMuZmlsZXMubWFwKChmKSA9PiBgXFx1MDAxYlszMm0ke2Z9XFx1MDAxYlszOW1gKS5qb2luKEVPTCkpO1xyXG4gICAgICAgIGZvciAoY29uc3QgZmlsZSBvZiB0aGlzLmZpbGVzKSB7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMucHVzaCh0aGlzLmNyZWF0ZUZpbGVXYXRjaGVyKGZpbGUpKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy5sb2coXCJXYXRjaGluZyBEaXJlY3RvcmllczpcIiArIEVPTCArIHRoaXMuZGlyZWN0b3JpZXMubWFwKChmKSA9PiBgXFx1MDAxYlszMm0ke2Z9XFx1MDAxYlszOW1gKS5qb2luKEVPTCkpO1xyXG4gICAgICAgIGZvciAoY29uc3QgZGlyIG9mIHRoaXMuZGlyZWN0b3JpZXMpIHtcclxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5wdXNoKHRoaXMuY3JlYXRlRGlyV2F0Y2hlcihkaXIpKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==