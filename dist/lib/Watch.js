"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const fs = require("fs");
const path = require("path");
const events_1 = require("events");
const globby_1 = require("globby");
const callsite_1 = __importDefault(require("callsite"));
const os_1 = require("os");
const Colors_1 = require("./Colors");
if (!Array.prototype.unique) {
    Array.prototype.unique = function () {
        return this.filter((value, index) => {
            return this.indexOf(value) === index;
        });
    };
}
class Watcher extends events_1.EventEmitter {
    /**
     * File Watching using NodeJS fs.watch
     * @param globPattern The glob or array of globs to match against
     * @param watchOptions Options object
     */
    constructor(globPattern, watchOptions = {}) {
        super();
        this.options = { lockDuration: 1000, absolute: true, encoding: "utf-8", persistent: true, recursive: true, verbose: false };
        this.watchers = [];
        this.locked = false;
        this.locks = [];
        this.options = { ...this.options, ...watchOptions };
        // Callsite Gets the directory of the file this constructor was called from so we can glob from there instead of here
        this.options.cwd = (typeof this.options.cwd === "undefined") ? path.dirname(callsite_1.default()[1].getFileName()) : this.options.cwd;
        this.files = this.globFiles(globPattern).map((g) => path.normalize(g));
        this.directories = this.files.map((f) => path.dirname(f)).unique();
    }
    log(fnName, ...logargs) {
        if (this.options.verbose) {
            // tslint:disable-next-line:no-console
            console.log(`${os_1.EOL}${Colors_1.Colors(`ReloadWatcher::${fnName}`, "yellow")}`, ...logargs, os_1.EOL);
        }
    }
    globFiles(globPattern) {
        return globby_1.sync(globPattern, this.options);
    }
    isDirectory(source) {
        return fs.lstatSync(source).isDirectory();
    }
    isFile(source) {
        return !fs.lstatSync(source).isDirectory();
    }
    getDirectories(source) {
        return fs.readdirSync(source).map((name) => path.normalize(path.join(source, name))).filter(this.isDirectory);
    }
    getFiles(dir) {
        return fs.readdirSync(dir).map((name) => path.normalize(path.join(dir, name))).filter(this.isFile);
    }
    onWatchEventFile(e, f) {
        const FN_NAME = "FileWatcher";
        if (this.locked || e !== "change") {
            return;
        }
        this.lock();
        this.log(FN_NAME, "Node.js FSEvent:", e, "Node FSEvent File:", f);
        this.emit("all", f);
        this.emit("change", f);
    }
    /**
     * fs.watch event handler for directories
     * We watch directories for add, rename delete events so we can add and remove new listeners as necessary
     *
     * @param e {string} event type
     * @param f {string} file
     * @param dir {string} the directory
     */
    onWatchEventDir(e, f, dir) {
        const FN_NAME = "DirectoryWatcher";
        if (this.locked || e !== "rename") {
            return;
        }
        this.lock();
        this.log(FN_NAME, "Node.js FSEvent:", e, "Node FSEvent File:", f, "Directory:", dir);
        const abs = path.join(dir, path.basename(f));
        if (!fs.existsSync(abs)) {
            const renamedFile = this.getRenamed(dir);
            if (typeof renamedFile !== "undefined") {
                this.log(FN_NAME, `Old File: ${abs}`);
                this.log(FN_NAME, `Renamed File: ${renamedFile}`);
                this.emit("all", abs, renamedFile);
                this.emit("rename", abs, renamedFile);
                this.removeWatcher(abs);
            }
            else {
                this.emit("all", abs);
                this.emit("delete", abs);
            }
            return;
        }
        if (!this.files.includes(abs)) {
            // Create
            this.watchers.push(this.createFileWatcher(abs));
            this.emit("all", abs);
            this.emit("add", abs);
        }
    }
    removeWatcher(file) {
        const watcherStruct = this.getWatcher(file);
        if (typeof watcherStruct !== "undefined") {
            watcherStruct.watcher.close();
            this.watchers.splice(this.watchers.indexOf(watcherStruct), 1);
        }
    }
    getRenamed(dir) {
        const FN_NAME = "isRename";
        const files = this.getFiles(dir);
        this.log(FN_NAME, "Disk Files:", files);
        this.log(FN_NAME, "Watched Files", this.files);
        for (const f of files) {
            if (!this.files.includes(f)) {
                return f;
            }
        }
        return undefined;
    }
    createFileWatcher(file) {
        return {
            target: file,
            watcher: fs.watch(file, this.options, (e, _) => { this.onWatchEventFile(e, file); })
        };
    }
    createDirWatcher(dir) {
        return {
            target: dir,
            watcher: fs.watch(dir, this.options, (e, f) => { this.onWatchEventDir(e, f, dir); })
        };
    }
    getWatcher(filename) {
        return this.watchers.find((w) => path.normalize(w.target) === path.normalize(filename));
    }
    lock() {
        this.locked = true;
        setTimeout(() => { this.locked = false; }, this.options.lockDuration);
    }
    /**
     * Attachs watch listeners and starts watching specified files
     * Available events are
     * `add` - Emitted when a file is created
     * `delete` - Emitted when a file is deleted
     * `change` - Emitted when a file change is detected
     * `rename` - Emitted when a file is renamed
     * `all` - Emitted for all the above events
     */
    Start() {
        const FN_NAME = "Start";
        this.log(FN_NAME, "Watching Files:" + os_1.EOL + this.files.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const file of this.files) {
            this.watchers.push(this.createFileWatcher(file));
        }
        this.log(FN_NAME, "Watching Directories:" + os_1.EOL + this.directories.map((f) => `\u001b[32m${f}\u001b[39m`).join(os_1.EOL));
        for (const dir of this.directories) {
            this.watchers.push(this.createDirWatcher(dir));
        }
        return this;
    }
}
exports.Watcher = Watcher;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV2F0Y2guanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL1dhdGNoLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7O0FBQUEseUJBQTBCO0FBQzFCLDZCQUE4QjtBQUM5QixtQ0FBc0M7QUFDdEMsbUNBQXNDO0FBQ3RDLHdEQUFnQztBQUVoQywyQkFBeUI7QUFDekIscUNBQTRDO0FBb0Q1QyxJQUFJLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEVBQUU7SUFDekIsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUc7UUFDckIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsS0FBVSxFQUFFLEtBQWEsRUFBRSxFQUFFO1lBQzdDLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsS0FBSyxLQUFLLENBQUM7UUFDekMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDLENBQUE7Q0FDSjtBQUlELGFBQXFCLFNBQVEscUJBQVk7SUFRckM7Ozs7T0FJRztJQUNILFlBQVksV0FBOEIsRUFBRSxlQUErQixFQUFFO1FBQ3pFLEtBQUssRUFBRSxDQUFDO1FBWEYsWUFBTyxHQUFtQixFQUFFLFlBQVksRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLENBQUM7UUFDdkksYUFBUSxHQUFvQixFQUFFLENBQUM7UUFDL0IsV0FBTSxHQUFZLEtBQUssQ0FBQztRQUN4QixVQUFLLEdBQWtCLEVBQUUsQ0FBQztRQVNoQyxJQUFJLENBQUMsT0FBTyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFFcEQscUhBQXFIO1FBQ3JILElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxHQUFHLENBQUMsT0FBTyxJQUFJLENB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TyxHQUFHLE9BQU8sQ0FBQTtRQUN2QixJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSxpQkFBaUIsR0FBRyxRQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBRyxDQUFDLENBQUMsQ0FBQztRQUN6RyxLQUFLLE1BQU0sSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDM0IsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDcEQ7UUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE9BQU8sRUFBRSx1QkFBdUIsR0FBRyxRQUFHLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLGFBQWEsQ0FBQyxZQUFZLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBRyxDQUFDLENBQUMsQ0FBQztRQUNySCxLQUFLLE1BQU0sR0FBRyxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUU7WUFDaEMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7U0FDbEQ7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0NBQ0o7QUF2S0QsMEJBdUtDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGZzID0gcmVxdWlyZShcImZzXCIpO1xyXG5pbXBvcnQgcGF0aCA9IHJlcXVpcmUoXCJwYXRoXCIpO1xyXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XHJcbmltcG9ydCB7IHN5bmMgYXMgZ2xvYiB9IGZyb20gXCJnbG9iYnlcIjtcclxuaW1wb3J0IENhbGxzaXRlIGZyb20gXCJjYWxsc2l0ZVwiO1xyXG5pbXBvcnQgeyBPcHRpb25zIGFzIEZhc3RHbG9iT3B0aW9ucyB9IGZyb20gJ2Zhc3QtZ2xvYic7XHJcbmltcG9ydCB7IEVPTCB9IGZyb20gXCJvc1wiO1xyXG5pbXBvcnQge0NvbG9ycywgTGVnYWxDb2xvcn0gZnJvbSBcIi4vQ29sb3JzXCI7XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIEZTV2F0Y2hPcHRpb25zIHtcclxuICAgIGVuY29kaW5nPzogc3RyaW5nO1xyXG4gICAgcGVyc2lzdGVudD86IGJvb2xlYW47XHJcbiAgICByZWN1cnNpdmU/OiBib29sZWFuO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoZXJTdHJ1Y3Qge1xyXG4gICAgdGFyZ2V0OiBzdHJpbmc7XHJcbiAgICB3YXRjaGVyOiBmcy5GU1dhdGNoZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRlNFdmVudExvY2sge1xyXG4gICAgZmlsZW5hbWU6IHN0cmluZztcclxuICAgIGxvY2tUaW1lOiBudW1iZXI7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRmlsZURlc2NyaXB0b3Ige1xyXG4gICAgYmFzZW5hbWU6IHN0cmluZztcclxuICAgIGZkOiBudW1iZXI7XHJcbiAgICBkaXJuYW1lOiBzdHJpbmc7XHJcbiAgICBhYnNvbHV0ZTogc3RyaW5nO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIFdhdGNoZXJPcHRpb25zIGV4dGVuZHMgRlNXYXRjaE9wdGlvbnMsIEZhc3RHbG9iT3B0aW9ucyB7XHJcbiAgICAvKipcclxuICAgICAqIFRoZSBkZWxheSBpbiBtaWxsaXNlY29uZHMgYmVmb3JlIGVtaXR0aW5nIGEgbmV3IEV2ZW50XHJcbiAgICAgKiBOb2RlSlMgZnMud2F0Y2ggZW1pdHMgZHVwbGljYXRlIGV2ZW50cyBhbW9uZyBvdGhlciBpZGlvc3luY3Jhc2VzLCB0aGlzIGNvbnRyb2xzIGhvdyBsb25nIHdlIHdhaXQgYmVmb3JlIHJlbGF5aW5nIGV2ZW50c1xyXG4gICAgICogQGRlZmF1bHQgNTAwMFxyXG4gICAgICovXHJcbiAgICBsb2NrRHVyYXRpb24/OiBudW1iZXI7XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBFbmFibGVzIHZlcmJvc2UgbG9nZ2luZ1xyXG4gICAgICogQGRlZmF1bHQgZmFsc2VcclxuICAgICAqL1xyXG4gICAgdmVyYm9zZT86IGJvb2xlYW47XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGVzY3JpcHRvckRpcmVjdG9yeSB7XHJcbiAgICBkaXJuYW1lOiBzdHJpbmc7XHJcbiAgICBkZXNjcmlwdG9yczogRmlsZURlc2NyaXB0b3JbXTtcclxufVxyXG5cclxuLy8gQWRkIHRoZSB1bmlxdWUgZXh0ZW5zaW9uIG1ldGhvZCB0byB0aGUgQXJyYXkgcHJvdG90eXBlXHJcbmRlY2xhcmUgZ2xvYmFsIHtcclxuICAgIGludGVyZmFjZSBBcnJheTxUPiB7XHJcbiAgICAgICAgdW5pcXVlOiAoKSA9PiBBcnJheTxUPjtcclxuICAgIH1cclxufVxyXG5cclxuaWYgKCFBcnJheS5wcm90b3R5cGUudW5pcXVlKSB7XHJcbiAgICBBcnJheS5wcm90b3R5cGUudW5pcXVlID0gZnVuY3Rpb24gKCkge1xyXG4gICAgICAgIHJldHVybiB0aGlzLmZpbHRlcigodmFsdWU6IGFueSwgaW5kZXg6IG51bWJlcikgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5pbmRleE9mKHZhbHVlKSA9PT0gaW5kZXg7XHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIExlZ2FsRXZlbnRzID0gXCJhZGRcIiB8IFwiZGVsZXRlXCIgfCBcImNoYW5nZVwiIHwgXCJyZW5hbWVcIiB8IFwiYWxsXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgV2F0Y2hlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XHJcbiAgICBwcm90ZWN0ZWQgZmlsZXM6IHN0cmluZ1tdO1xyXG4gICAgcHJvdGVjdGVkIGRpcmVjdG9yaWVzOiBzdHJpbmdbXTtcclxuICAgIHByb3RlY3RlZCBvcHRpb25zOiBXYXRjaGVyT3B0aW9ucyA9IHsgbG9ja0R1cmF0aW9uOiAxMDAwLCBhYnNvbHV0ZTogdHJ1ZSwgZW5jb2Rpbmc6IFwidXRmLThcIiwgcGVyc2lzdGVudDogdHJ1ZSwgcmVjdXJzaXZlOiB0cnVlLCB2ZXJib3NlOiBmYWxzZSB9O1xyXG4gICAgcHJvdGVjdGVkIHdhdGNoZXJzOiBXYXRjaGVyU3RydWN0W10gPSBbXTtcclxuICAgIHByb3RlY3RlZCBsb2NrZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICAgIHByb3RlY3RlZCBsb2NrczogRlNFdmVudExvY2tbXSA9IFtdO1xyXG5cclxuICAgIC8qKlxyXG4gICAgICogRmlsZSBXYXRjaGluZyB1c2luZyBOb2RlSlMgZnMud2F0Y2hcclxuICAgICAqIEBwYXJhbSBnbG9iUGF0dGVybiBUaGUgZ2xvYiBvciBhcnJheSBvZiBnbG9icyB0byBtYXRjaCBhZ2FpbnN0XHJcbiAgICAgKiBAcGFyYW0gd2F0Y2hPcHRpb25zIE9wdGlvbnMgb2JqZWN0IFxyXG4gICAgICovXHJcbiAgICBjb25zdHJ1Y3RvcihnbG9iUGF0dGVybjogc3RyaW5nIHwgc3RyaW5nW10sIHdhdGNoT3B0aW9uczogV2F0Y2hlck9wdGlvbnMgPSB7fSkge1xyXG4gICAgICAgIHN1cGVyKCk7XHJcbiAgICAgICAgdGhpcy5vcHRpb25zID0geyAuLi50aGlzLm9wdGlvbnMsIC4uLndhdGNoT3B0aW9ucyB9O1xyXG5cclxuICAgICAgICAvLyBDYWxsc2l0ZSBHZXRzIHRoZSBkaXJlY3Rvcnkgb2YgdGhlIGZpbGUgdGhpcyBjb25zdHJ1Y3RvciB3YXMgY2FsbGVkIGZyb20gc28gd2UgY2FuIGdsb2IgZnJvbSB0aGVyZSBpbnN0ZWFkIG9mIGhlcmVcclxuICAgICAgICB0aGlzLm9wdGlvbnMuY3dkID0gKHR5cGVvZiB0aGlzLm9wdGlvbnMuY3dkID09PSBcInVuZGVmaW5lZFwiKSA/IHBhdGguZGlybmFtZShDYWxsc2l0ZSgpWzFdLmdldEZpbGVOYW1lKCkpIDogdGhpcy5vcHRpb25zLmN3ZDtcclxuXHJcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZ2xvYkZpbGVzKGdsb2JQYXR0ZXJuKS5tYXAoKGcpID0+IHBhdGgubm9ybWFsaXplKGcpKTtcclxuICAgICAgICB0aGlzLmRpcmVjdG9yaWVzID0gdGhpcy5maWxlcy5tYXAoKGYpID0+IHBhdGguZGlybmFtZShmKSkudW5pcXVlKCk7XHJcblxyXG5cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgbG9nKGZuTmFtZTogc3RyaW5nLCAuLi5sb2dhcmdzOiBhbnlbXSk6IHZvaWQge1xyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMudmVyYm9zZSkge1xyXG4gICAgICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bm8tY29uc29sZVxyXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhgJHtFT0x9JHtDb2xvcnMoYFJlbG9hZFdhdGNoZXI6OiR7Zm5OYW1lfWAsIFwieWVsbG93XCIpIH1gLCAuLi5sb2dhcmdzLCBFT0wpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgZ2xvYkZpbGVzKGdsb2JQYXR0ZXJuOiBzdHJpbmcgfCBzdHJpbmdbXSk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZ2xvYihnbG9iUGF0dGVybiwgdGhpcy5vcHRpb25zKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNEaXJlY3Rvcnkoc291cmNlOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gZnMubHN0YXRTeW5jKHNvdXJjZSkuaXNEaXJlY3RvcnkoKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgaXNGaWxlKHNvdXJjZTogc3RyaW5nKTogYm9vbGVhbiB7XHJcbiAgICAgICAgcmV0dXJuICFmcy5sc3RhdFN5bmMoc291cmNlKS5pc0RpcmVjdG9yeSgpO1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXREaXJlY3Rvcmllcyhzb3VyY2U6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgICAgICByZXR1cm4gZnMucmVhZGRpclN5bmMoc291cmNlKS5tYXAoKG5hbWU6IHN0cmluZykgPT4gcGF0aC5ub3JtYWxpemUocGF0aC5qb2luKHNvdXJjZSwgbmFtZSkpKS5maWx0ZXIodGhpcy5pc0RpcmVjdG9yeSk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJvdGVjdGVkIGdldEZpbGVzKGRpcjogc3RyaW5nKTpzdHJpbmdbXSB7XHJcbiAgICAgICAgcmV0dXJuIGZzLnJlYWRkaXJTeW5jKGRpcikubWFwKChuYW1lOiBzdHJpbmcpID0+IHBhdGgubm9ybWFsaXplKHBhdGguam9pbihkaXIsIG5hbWUpKSkuZmlsdGVyKHRoaXMuaXNGaWxlKTtcclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgb25XYXRjaEV2ZW50RmlsZShlOiBzdHJpbmcsIGY6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IEZOX05BTUUgPSBcIkZpbGVXYXRjaGVyXCI7XHJcbiAgICAgICAgaWYgKHRoaXMubG9ja2VkIHx8IGUgIT09IFwiY2hhbmdlXCIpIHsgcmV0dXJuOyB9XHJcbiAgICAgICAgdGhpcy5sb2NrKCk7XHJcblxyXG4gICAgICAgIHRoaXMubG9nKEZOX05BTUUsICBcIk5vZGUuanMgRlNFdmVudDpcIiwgZSwgXCJOb2RlIEZTRXZlbnQgRmlsZTpcIiwgZik7XHJcbiAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGYpO1xyXG4gICAgICAgIHRoaXMuZW1pdChcImNoYW5nZVwiLCBmKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIGZzLndhdGNoIGV2ZW50IGhhbmRsZXIgZm9yIGRpcmVjdG9yaWVzXHJcbiAgICAgKiBXZSB3YXRjaCBkaXJlY3RvcmllcyBmb3IgYWRkLCByZW5hbWUgZGVsZXRlIGV2ZW50cyBzbyB3ZSBjYW4gYWRkIGFuZCByZW1vdmUgbmV3IGxpc3RlbmVycyBhcyBuZWNlc3NhcnlcclxuICAgICAqIFxyXG4gICAgICogQHBhcmFtIGUge3N0cmluZ30gZXZlbnQgdHlwZVxyXG4gICAgICogQHBhcmFtIGYge3N0cmluZ30gZmlsZVxyXG4gICAgICogQHBhcmFtIGRpciB7c3RyaW5nfSB0aGUgZGlyZWN0b3J5XHJcbiAgICAgKi9cclxuICAgIHByb3RlY3RlZCBvbldhdGNoRXZlbnREaXIoZTogc3RyaW5nLCBmOiBzdHJpbmcsIGRpcjogc3RyaW5nKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgRk5fTkFNRSA9IFwiRGlyZWN0b3J5V2F0Y2hlclwiO1xyXG4gICAgICAgIGlmICh0aGlzLmxvY2tlZCB8fCBlICE9PSBcInJlbmFtZVwiKSB7IHJldHVybjsgfVxyXG4gICAgICAgIHRoaXMubG9jaygpO1xyXG5cclxuICAgICAgICB0aGlzLmxvZyhGTl9OQU1FLCBcIk5vZGUuanMgRlNFdmVudDpcIiwgZSwgXCJOb2RlIEZTRXZlbnQgRmlsZTpcIiwgZiwgXCJEaXJlY3Rvcnk6XCIsIGRpcik7XHJcbiAgICAgICAgY29uc3QgYWJzID0gcGF0aC5qb2luKGRpciwgcGF0aC5iYXNlbmFtZShmKSk7XHJcbiAgICAgICAgaWYgKCFmcy5leGlzdHNTeW5jKGFicykpIHtcclxuICAgICAgICAgICAgXHJcbiAgICAgICAgICAgIGNvbnN0IHJlbmFtZWRGaWxlID0gdGhpcy5nZXRSZW5hbWVkKGRpcik7XHJcbiAgICAgICAgICAgIGlmICh0eXBlb2YgcmVuYW1lZEZpbGUgIT09IFwidW5kZWZpbmVkXCIpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKEZOX05BTUUsIGBPbGQgRmlsZTogJHthYnN9YClcclxuICAgICAgICAgICAgICAgIHRoaXMubG9nKEZOX05BTUUsIGBSZW5hbWVkIEZpbGU6ICR7cmVuYW1lZEZpbGV9YClcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcImFsbFwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMuZW1pdChcInJlbmFtZVwiLCBhYnMsIHJlbmFtZWRGaWxlKTtcclxuICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlV2F0Y2hlcihhYnMpO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGFicyk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmVtaXQoXCJkZWxldGVcIiwgYWJzKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByZXR1cm47XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGlmICghdGhpcy5maWxlcy5pbmNsdWRlcyhhYnMpKSB7XHJcbiAgICAgICAgICAgIC8vIENyZWF0ZVxyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2godGhpcy5jcmVhdGVGaWxlV2F0Y2hlcihhYnMpKTtcclxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiYWxsXCIsIGFicyk7XHJcbiAgICAgICAgICAgIHRoaXMuZW1pdChcImFkZFwiLCBhYnMpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBwcm90ZWN0ZWQgcmVtb3ZlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgICAgICBjb25zdCB3YXRjaGVyU3RydWN0ID0gdGhpcy5nZXRXYXRjaGVyKGZpbGUpO1xyXG4gICAgICAgIGlmICh0eXBlb2Ygd2F0Y2hlclN0cnVjdCAhPT0gXCJ1bmRlZmluZWRcIikgeyBcclxuICAgICAgICAgICAgd2F0Y2hlclN0cnVjdC53YXRjaGVyLmNsb3NlKCk7XHJcbiAgICAgICAgICAgIHRoaXMud2F0Y2hlcnMuc3BsaWNlKHRoaXMud2F0Y2hlcnMuaW5kZXhPZih3YXRjaGVyU3RydWN0KSwgMSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRSZW5hbWVkKGRpcjogc3RyaW5nKTogc3RyaW5nIHtcclxuICAgICAgICBjb25zdCBGTl9OQU1FID0gXCJpc1JlbmFtZVwiO1xyXG4gICAgICAgIGNvbnN0IGZpbGVzID0gdGhpcy5nZXRGaWxlcyhkaXIpO1xyXG4gICAgICAgIHRoaXMubG9nKEZOX05BTUUsIFwiRGlzayBGaWxlczpcIiwgZmlsZXMpO1xyXG4gICAgICAgIHRoaXMubG9nKEZOX05BTUUsIFwiV2F0Y2hlZCBGaWxlc1wiLCB0aGlzLmZpbGVzKTtcclxuICAgICAgICBmb3IgKGNvbnN0IGYgb2YgZmlsZXMpIHtcclxuICAgICAgICAgICAgaWYgKCF0aGlzLmZpbGVzLmluY2x1ZGVzKGYpKSB7IHJldHVybiBmOyB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB1bmRlZmluZWQ7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBjcmVhdGVGaWxlV2F0Y2hlcihmaWxlOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICB0YXJnZXQ6IGZpbGUsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGZpbGUsIHRoaXMub3B0aW9ucywgKGU6IHN0cmluZywgXykgPT4geyB0aGlzLm9uV2F0Y2hFdmVudEZpbGUoZSwgZmlsZSk7IH0pXHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuICAgIHByb3RlY3RlZCBjcmVhdGVEaXJXYXRjaGVyKGRpcjogc3RyaW5nKTogV2F0Y2hlclN0cnVjdCB7XHJcbiAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgdGFyZ2V0OiBkaXIsXHJcbiAgICAgICAgICAgIHdhdGNoZXI6IGZzLndhdGNoKGRpciwgdGhpcy5vcHRpb25zLCAoZTogc3RyaW5nLCBmOiBzdHJpbmcpID0+IHsgdGhpcy5vbldhdGNoRXZlbnREaXIoZSwgZiwgZGlyKTsgfSlcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHByb3RlY3RlZCBnZXRXYXRjaGVyKGZpbGVuYW1lOiBzdHJpbmcpOiBXYXRjaGVyU3RydWN0IHtcclxuICAgICAgICByZXR1cm4gdGhpcy53YXRjaGVycy5maW5kKCh3KSA9PiBwYXRoLm5vcm1hbGl6ZSh3LnRhcmdldCkgPT09IHBhdGgubm9ybWFsaXplKGZpbGVuYW1lKSk7XHJcbiAgICB9XHJcbiAgICBcclxuICAgIHByb3RlY3RlZCBsb2NrKCk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubG9ja2VkID0gdHJ1ZTtcclxuICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHsgdGhpcy5sb2NrZWQgPSBmYWxzZTsgfSwgdGhpcy5vcHRpb25zLmxvY2tEdXJhdGlvbik7XHJcbiAgICB9XHJcblxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQXR0YWNocyB3YXRjaCBsaXN0ZW5lcnMgYW5kIHN0YXJ0cyB3YXRjaGluZyBzcGVjaWZpZWQgZmlsZXNcclxuICAgICAqIEF2YWlsYWJsZSBldmVudHMgYXJlIFxyXG4gICAgICogYGFkZGAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIGNyZWF0ZWRcclxuICAgICAqIGBkZWxldGVgIC0gRW1pdHRlZCB3aGVuIGEgZmlsZSBpcyBkZWxldGVkXHJcbiAgICAgKiBgY2hhbmdlYCAtIEVtaXR0ZWQgd2hlbiBhIGZpbGUgY2hhbmdlIGlzIGRldGVjdGVkIFxyXG4gICAgICogYHJlbmFtZWAgLSBFbWl0dGVkIHdoZW4gYSBmaWxlIGlzIHJlbmFtZWRcclxuICAgICAqIGBhbGxgIC0gRW1pdHRlZCBmb3IgYWxsIHRoZSBhYm92ZSBldmVudHNcclxuICAgICAqL1xyXG4gICAgcHVibGljIFN0YXJ0KCk6IHRoaXMge1xyXG4gICAgICAgIGNvbnN0IEZOX05BTUUgPSBcIlN0YXJ0XCJcclxuICAgICAgICB0aGlzLmxvZyhGTl9OQU1FLCBcIldhdGNoaW5nIEZpbGVzOlwiICsgRU9MICsgdGhpcy5maWxlcy5tYXAoKGYpID0+IGBcXHUwMDFiWzMybSR7Zn1cXHUwMDFiWzM5bWApLmpvaW4oRU9MKSk7XHJcbiAgICAgICAgZm9yIChjb25zdCBmaWxlIG9mIHRoaXMuZmlsZXMpIHtcclxuICAgICAgICAgICAgdGhpcy53YXRjaGVycy5wdXNoKHRoaXMuY3JlYXRlRmlsZVdhdGNoZXIoZmlsZSkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmxvZyhGTl9OQU1FLCBcIldhdGNoaW5nIERpcmVjdG9yaWVzOlwiICsgRU9MICsgdGhpcy5kaXJlY3Rvcmllcy5tYXAoKGYpID0+IGBcXHUwMDFiWzMybSR7Zn1cXHUwMDFiWzM5bWApLmpvaW4oRU9MKSk7XHJcbiAgICAgICAgZm9yIChjb25zdCBkaXIgb2YgdGhpcy5kaXJlY3Rvcmllcykge1xyXG4gICAgICAgICAgICB0aGlzLndhdGNoZXJzLnB1c2godGhpcy5jcmVhdGVEaXJXYXRjaGVyKGRpcikpO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcbn1cclxuIl19